# 08-MySQL的数据目录

## 8.1 数据库和文件系统的关系

`InnoDB`、`MyISAM`存储引擎通过操作系统的文件系统把表存储在磁盘上。

## 8.2 MySQL数据目录

MySQL服务器启动时会到它的`数据目录`下加载一些文件，之后运行过程中产生的数据也都会存储到这个目录。

### 8.2.1 数据目录和安装目录的区别

- MySQL的安装目录存储了客户端和服务器等程序。
- MySQL的数据目录存储了运行过程中产生的数据。

### 8.2.2 如何确定MySQL中的数据目录

数据目录对应着一个系统变量`datadir`，在客户端中查看这个系统变量：

    mysql> SHOW VARIABLES LIKE 'datadir';
    +---------------+-----------------+
    | Variable_name | Value           |
    +---------------+-----------------+
    | datadir       | /var/lib/mysql/ |
    +---------------+-----------------+

## 8.3 数据目录的结构

### 8.3.1 数据库在文件系统中的表示

每个数据库都对应数据目录下的一个子目录。

当新建一个数据库时，MySQL做两个操作：
1. 在数据目录下创建一个和数据库名同名的子目录。
2. 在子目录下创建一个名为db.opt的文件，文件中包含了该数据库的各种属性，如数据库的字符集和比较规则。

        cat db.opt
        default-character-set=utf8mb4
        default-collation=utf8mb4_general_ci

数据目录下除了`information_schema`这个系统数据库外，其他的数据库在数据目录下都有对应的子目录。

这个系统数据库比较特殊，没有使用相应的数据库目录。

### 8.3.2 表在文件系统中的表示

表的信息分为两种：
1. 表结构的定义
2. 表中的数据

InnoDB和MyISAM都在数据库子目录下创建了一个用于描述表结构的文件：

    表名.frm

**InnoDB是如何存储表数据的**

实现原理：
- InnoDB其实是使用页为基本单位来管理存储空间的，默认的页大小为16KB。
- 对于InnoDB存储引擎来说，每个索引都对应着一棵B+树，该B+树的每个节点都是一个数据页，数据页之间不必要是物理连续的，因为数据页之间有双向链表来维护着这些页的顺序。
- InnoDB的聚簇索引的叶子节点存储了完整的用户记录，也就是所谓的索引即数据，数据即索引。

为了更好的管理这些页，InnoDB提出了一个表空间的概念。  
表空间是一个抽象的概念，它可以对应文件系统上一个或多个真实文件。  
每一个表空间可以被划分为很多个页，表数据就存放在某个表空间下的某些页里。

表空间划分为几种不同的类型：

- 系统表空间（system tablespace）

系统表空间可以对应文件系统上一个或多个实际的文件。  
默认情况下，InnoDB会在数据目录下创建一个名为ibdata1、大小为12M的文件，这个文件就是对应的系统表空间在文件系统上的表示。

在配置文件中设置系统表空间为多个文件以及文件大小：

    [server]
    innodb_data_file_path=data1:512M;data2:512M:autoextend

这样在MySQL启动之后就会创建这两个512M大小的文件作为系统表空间，其中的autoextend表明这两个文件如果不够用会自动扩展data2文件的大小。

**注意**

MySQL服务器中，系统表空间只有一份。  
MySQL5.5.7到MySQL5.6.6之间的各个版本表中的数据都会被默认存储到系统表空间。

- 独立表空间(file-per-table tablespace)

MySQL5.6.6以及之后的版本中，InnoDB并不会默认的把各个表的数据存储到系统表空间中，而是为每一个表建立一个独立表空间。  
使用独立表空间存储表数据，会在数据库子目录下创建一个表示该独立表空间的文件，文件名和表名相同，扩展名为`.ibd`。  
表的数据和索引都存储在独立表空间文件中。

    表名.ibd

在配置文件中设置使用系统表空间或独立表空间：

    [server]
    innodb_file_per_table=0

当innodb_file_per_table的值为0时，代表使用系统表空间。  
当innodb_file_per_table的值为1时，代表使用独立表空间。

转移表空间：

    // 把已经存在系统表空间中的表转移到独立表空间
    ALTER TABLE 表名 TABLESPACE [=] innodb_file_per_table;

    // 把已经存在独立表空间中的表转移到系统表空间
    ALTER TABLE 表名 TABLESPACE [=] innodb_system;

- 其他类型的表空间

现在还新提出了一些不同类型的表空间，比如通用表空间、undo表空间、临时表空间等。

**MyISAM是如何存储表数据的**

MyISAM中的索引全部都是二级索引，该存储引擎的数据和索引是分开存放的，所以在文件系统中也是使用不同的文件来存储数据文件和索引文件。  

MyISAM没有表空间的概念，表数据都存放到对应的数据库子目录下，一个表创建三个文件：

    表名.frm
    表名.MYD // 数据文件
    表名.MYI // 索引文件

**视图在文件系统中的表示**

视图其实是虚拟的表，也就是某个查询语句的一个别名而已，所以视图不需要存储真实数据，只需要存储视图的结构，描述视图结构的文件也存储到所属数据库对应的子目录下边：

    视图名.frm

### 8.3.3 其他的文件

数据目录下还包括为一些额外文件，主要包括这几种类型的文件：

- 服务器进程文件
- 服务器日志文件
- 默认/自动生成的SSL和RSA证书和密钥文件

## 8.4 文件系统对数据库的影响

- 数据库名称和表名称不得超过文件系统所允许的最大长度
- 特殊字符的问题
- 文件长度受文件系统最大长度限制

## 8.5 MySQL系统数据库简介

MySQL的几个系统数据库，包含服务器运行过程中所需的一些信息以及一些运行状态信息。

- mysql
  
  这个数据库很核心，它存储了MySQL的用户账户和权限信息，一些存储过程、事件的定义信息，一些运行过程中产生的日志信息，一些帮助信息以及时区信息等。

- information_schema
  
  这个数据库保存着MySQL服务器维护的所有其他数据库的信息，比如有哪些表、哪些视图、哪些触发器、哪些列、哪些索引等等。这些信息并不是真实的用户数据，而是一些描述性信息，有时候也称之为元数据。

- performance_schema
  
  这个数据库里主要保存MySQL服务器运行过程中的一些状态信息，算是对MySQL服务器的一个性能监控。包括统计最近执行了哪些语句，在执行过程的每个阶段都花费了多长时间，内存的使用情况等等信息。

- sys
  
  这个数据库主要是通过视图的形式把 information_schema 和 performance_schema 结合起来，让程序员可以更方便的了解MySQL服务器的一些性能信息。

# 完